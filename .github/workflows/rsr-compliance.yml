name: RSR Compliance

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

env:
  # Force colors in output
  FORCE_COLOR: 1
  TERM: xterm-256color

jobs:
  rsr-validate:
    name: Validate RSR Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation files
        run: |
          echo "üìö Checking RSR documentation files..."
          for file in README.md LICENSE.txt SECURITY.md CONTRIBUTING.md CODE_OF_CONDUCT.md MAINTAINERS.md CHANGELOG.md; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå Missing: $file"
              exit 1
            fi
          done

      - name: Check .well-known directory
        run: |
          echo "üåê Checking .well-known/ directory..."
          for file in .well-known/security.txt .well-known/ai.txt .well-known/humans.txt; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå Missing: $file"
              exit 1
            fi
          done

      - name: Check build automation
        run: |
          echo "üî® Checking build automation..."
          if [ -f "justfile" ]; then
            echo "‚úÖ justfile present"
          else
            echo "‚ùå Missing: justfile"
            exit 1
          fi

      - name: Verify dual licensing
        run: |
          echo "‚öñÔ∏è  Checking dual licensing..."
          if grep -q "MIT" LICENSE.txt && grep -q "Palimpsest" LICENSE.txt; then
            echo "‚úÖ Dual license present (MIT + Palimpsest)"
          else
            echo "‚ùå Dual license not found"
            exit 1
          fi

      - name: Check security.txt expiration
        run: |
          echo "üîí Checking security.txt expiration..."
          if [ -f ".well-known/security.txt" ]; then
            if grep -q "Expires:" .well-known/security.txt; then
              expires_line=$(grep "Expires:" .well-known/security.txt)
              echo "Found: $expires_line"
              echo "‚úÖ Expiration date present"
              # TODO: Add actual date validation
            else
              echo "‚ö†Ô∏è  Warning: No expiration date in security.txt"
            fi
          fi

      - name: RSR Compliance Summary
        run: |
          echo "üìä RSR Compliance Summary"
          echo "=========================="
          echo ""
          echo "‚úÖ Documentation: 7/7 files"
          echo "‚úÖ .well-known/: 3/3 files"
          echo "‚úÖ Build automation: justfile present"
          echo "‚úÖ Dual licensing: MIT + Palimpsest v0.8"
          echo ""
          echo "üéâ RSR Bronze compliance verified!"
