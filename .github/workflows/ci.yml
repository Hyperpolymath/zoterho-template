name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-rsr:
    name: RSR Compliance
    uses: ./.github/workflows/rsr-compliance.yml

  test-examples:
    name: Test Examples
    needs: validate-rsr
    uses: ./.github/workflows/test-examples.yml

  security-checks:
    name: Security Checks
    needs: validate-rsr
    uses: ./.github/workflows/security.yml
    permissions:
      contents: read
      security-events: write

  documentation:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for broken links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
          check-modified-files-only: 'no'

      - name: Check markdown formatting
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: '**/*.md'

  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [validate-rsr, test-examples, security-checks, documentation]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.validate-rsr.result }}" != "success" ] || \
             [ "${{ needs.test-examples.result }}" != "success" ] || \
             [ "${{ needs.security-checks.result }}" != "success" ] || \
             [ "${{ needs.documentation.result }}" != "success" ]; then
            echo "❌ Some checks failed"
            exit 1
          fi
          echo "✅ All checks passed!"
